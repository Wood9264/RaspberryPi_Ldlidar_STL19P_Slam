<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: Arial, sans-serif;
    }

    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 18px;
      border: 2px solid #3498db;
      border-radius: 5px;
      background-color: #3498db;
      color: #ffffff;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #2980b9;
    }

    .status {
      margin: 10px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
    }

    .status.connected {
      background-color: #27ae60;
      color: white;
    }

    .status.disconnected {
      background-color: #e74c3c;
      color: white;
    }

    .connection-info {
      margin-bottom: 20px;
    }
    
    /* 添加用于显示cmd_vel的样式 */
    .velocity-display {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
      width: 300px;
      text-align: center;
    }
    
    .velocity-value {
      font-family: monospace;
      font-size: 14px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/roslib@1.3.0/build/roslib.js"></script>
</head>

<body>
  <h1>ROS Web Controller</h1>
  
  <div class="connection-info">
    <div id="status" class="status disconnected">未连接</div>
    <div>
      <label for="port">Rosbridge端口：</label>
      <input type="text" id="port" value="9090" />
      <button onclick="connect()">连接</button>
    </div>
  </div>
  
  <div>
    <button onclick="moveForward()">Forward</button>
    <button onclick="moveBackward()">Backward</button>
  </div>
  <div>
    <button onclick="moveLeft()">Left</button>
    <button onclick="stopMovement()">Stop</button>
    <button onclick="moveRight()">Right</button>
  </div>

  <!-- 添加cmd_vel显示区域 -->
  <div class="velocity-display">
    <h3>当前速度命令</h3>
    <div id="cmd-vel-display" class="velocity-value">
      等待数据...
    </div>
  </div>

  <script>
    let ros;
    let cmdVel;
    let cmdVelSubscriber; // 添加订阅者变量
    const statusElement = document.getElementById('status');

    function connect() {
      // 断开现有连接（如果有）
      if (ros) {
        ros.close();
      }

      // 获取当前页面的主机名/IP地址
      const currentHost = window.location.hostname;
      const port = document.getElementById('port').value;
      const rosbridgeUrl = `ws://${currentHost}:${port}`;
      
      statusElement.innerHTML = `正在连接到 ${rosbridgeUrl}...`;
      statusElement.className = 'status disconnected';

      ros = new ROSLIB.Ros({
        url: rosbridgeUrl
      });

      ros.on('connection', () => {
        console.log('Connected to ROS Bridge');
        statusElement.innerHTML = `已连接到 ${rosbridgeUrl}`;
        statusElement.className = 'status connected';
        
        cmdVel = new ROSLIB.Topic({
          ros: ros,
          name: '/cmd_vel',
          messageType: 'geometry_msgs/Twist'
        });

        // 创建订阅者
        cmdVelSubscriber = new ROSLIB.Topic({
          ros: ros,
          name: '/cmd_vel',
          messageType: 'geometry_msgs/Twist'
        });
        
        // 订阅并处理接收到的消息
        cmdVelSubscriber.subscribe(function(message) {
          updateCmdVelDisplay(message);
        });
      });

      ros.on('error', (error) => {
        console.error('Error connecting to ROS: ', error);
        statusElement.innerHTML = `连接失败: ${error}`;
        statusElement.className = 'status disconnected';
      });

      ros.on('close', () => {
        console.log('Disconnected from ROS');
        statusElement.innerHTML = '已断开连接';
        statusElement.className = 'status disconnected';
        
        if (cmdVelSubscriber) {
          cmdVelSubscriber.unsubscribe();
        }
        
        document.getElementById('cmd-vel-display').innerHTML = '等待数据...';
      });
    }

    // 添加更新显示的函数
    function updateCmdVelDisplay(message) {
      const cmdVelDisplay = document.getElementById('cmd-vel-display');
      const formattedMsg = `线速度: [x: ${message.linear.x.toFixed(2)}, y: ${message.linear.y.toFixed(2)}, z: ${message.linear.z.toFixed(2)}]<br>
                            角速度: [x: ${message.angular.x.toFixed(2)}, y: ${message.angular.y.toFixed(2)}, z: ${message.angular.z.toFixed(2)}]`;
      cmdVelDisplay.innerHTML = formattedMsg;
    }

    function move(direction) {
      if (!ros) {
        console.error('ROS connection not established');
        alert('请先连接到ROS');
        return;
      }

      if (!cmdVel) {
        console.error('Publisher not created');
        alert('Publisher not created');
        return;
      }

      const twist = new ROSLIB.Message({
        linear: {
          x: direction.linear.x,
          y: direction.linear.y,
          z: direction.linear.z
        },
        angular: {
          x: direction.angular.x,
          y: direction.angular.y,
          z: direction.angular.z
        }
      });

      cmdVel.publish(twist);
      // 直接更新显示，无需等待订阅回调
      updateCmdVelDisplay(twist);
    }

    function moveForward() {
      const moveForwardMsg = {
        linear: { x: 0.2, y: 0, z: 0 },
        angular: { x: 0, y: 0, z: 0 }
      };
      move(moveForwardMsg);
    }

    function moveBackward() {
      const moveBackwardMsg = {
        linear: { x: -0.2, y: 0, z: 0 },
        angular: { x: 0, y: 0, z: 0 }
      };
      move(moveBackwardMsg);
    }

    function moveLeft() {
      const moveLeftMsg = {
        linear: { x: 0, y: 0.0, z: 0 },
        angular: { x: 0, y: 0, z: 0.5 }
      };
      move(moveLeftMsg);
    }

    function moveRight() {
      const moveRightMsg = {
        linear: { x: 0, y: 0, z: 0 },
        angular: { x: 0, y: 0, z: -0.5 }
      };
      move(moveRightMsg);
    }

    function stopMovement() {
      const stopMsg = {
        linear: { x: 0, y: 0, z: 0 },
        angular: { x: 0, y: 0, z: 0 }
      };
      move(stopMsg);
    }

    // 页面加载完成后自动连接
    window.onload = function() {
      // 延迟一点时间再连接，确保DOM元素已加载
      setTimeout(connect, 500);
    }
  </script>
</body>

</html>