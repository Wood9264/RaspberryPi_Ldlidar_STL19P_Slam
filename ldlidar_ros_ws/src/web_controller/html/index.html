<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: Arial, sans-serif;
    }

    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 18px;
      border: 2px solid #3498db;
      border-radius: 5px;
      background-color: #3498db;
      color: #ffffff;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #2980b9;
    }

    .status {
      margin: 10px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
    }

    .status.connected {
      background-color: #27ae60;
      color: white;
    }

    .status.disconnected {
      background-color: #e74c3c;
      color: white;
    }

    .connection-info {
      margin-bottom: 20px;
    }
    
    /* 添加用于显示cmd_vel的样式 */
    .velocity-display {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
      width: 300px;
      text-align: center;
    }
    
    .velocity-value {
      font-family: monospace;
      font-size: 14px;
    }

    /* 激光点云显示区域样式 */
    .scan-display {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
      width: 400px;
      text-align: center;
    }
    
    #scan-canvas {
      border: 1px solid #333;
      background-color: #000;
      margin: 10px auto;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/roslib@1.3.0/build/roslib.js"></script>
</head>

<body>
  <h1>ROS Web Controller</h1>
  
  <div class="connection-info">
    <div id="status" class="status disconnected">未连接</div>
    <div>
      <label for="port">Rosbridge端口：</label>
      <input type="text" id="port" value="9090" />
      <button onclick="connect()">连接</button>
    </div>
  </div>
  
  <div>
    <button onclick="moveForward()">Forward</button>
    <button onclick="moveBackward()">Backward</button>
  </div>
  <div>
    <button onclick="moveLeft()">Left</button>
    <button onclick="stopMovement()">Stop</button>
    <button onclick="moveRight()">Right</button>
  </div>

  <!-- 添加cmd_vel显示区域 -->
  <div class="velocity-display">
    <h3>当前速度命令</h3>
    <div id="cmd-vel-display" class="velocity-value">
      等待数据...
    </div>
  </div>

  <!-- 添加激光点云显示区域 -->
  <div class="scan-display">
    <h3>激光点云数据</h3>
    <canvas id="scan-canvas" width="360" height="360"></canvas>
  </div>

  <script>
    let ros;
    let cmdVel;
    let scanSubscriber; // 替换为scan订阅者
    const statusElement = document.getElementById('status');
    let canvas, ctx; // 画布和上下文

    function connect() {
      // 断开现有连接（如果有）
      if (ros) {
        ros.close();
      }

      // 初始化画布
      canvas = document.getElementById('scan-canvas');
      ctx = canvas.getContext('2d');
      
      // 清空画布
      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // 获取当前页面的主机名/IP地址
      const currentHost = window.location.hostname;
      const port = document.getElementById('port').value;
      const rosbridgeUrl = `ws://${currentHost}:${port}`;
      
      statusElement.innerHTML = `正在连接到 ${rosbridgeUrl}...`;
      statusElement.className = 'status disconnected';

      ros = new ROSLIB.Ros({
        url: rosbridgeUrl
      });

      ros.on('connection', () => {
        console.log('Connected to ROS Bridge');
        statusElement.innerHTML = `已连接到 ${rosbridgeUrl}`;
        statusElement.className = 'status connected';
        
        cmdVel = new ROSLIB.Topic({
          ros: ros,
          name: '/cmd_vel',
          messageType: 'geometry_msgs/Twist'
        });

        // 创建激光扫描订阅者
        scanSubscriber = new ROSLIB.Topic({
          ros: ros,
          name: '/scan',
          messageType: 'sensor_msgs/LaserScan'
        });
        
        // 订阅激光扫描数据
        scanSubscriber.subscribe(function(message) {
          displayScanData(message);
        });
      });

      ros.on('error', (error) => {
        console.error('Error connecting to ROS: ', error);
        statusElement.innerHTML = `连接失败: ${error}`;
        statusElement.className = 'status disconnected';
      });

      ros.on('close', () => {
        console.log('Disconnected from ROS');
        statusElement.innerHTML = '已断开连接';
        statusElement.className = 'status disconnected';
        
        if (scanSubscriber) {
          scanSubscriber.unsubscribe();
        }
        
        // 清空画布
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        document.getElementById('cmd-vel-display').innerHTML = '等待数据...';
      });
    }

    // 添加更新显示的函数
    function updateCmdVelDisplay(message) {
      const cmdVelDisplay = document.getElementById('cmd-vel-display');
      const formattedMsg = `线速度: [x: ${message.linear.x.toFixed(2)}, y: ${message.linear.y.toFixed(2)}, z: ${message.linear.z.toFixed(2)}]<br>
                            角速度: [x: ${message.angular.x.toFixed(2)}, y: ${message.angular.y.toFixed(2)}, z: ${message.angular.z.toFixed(2)}]`;
      cmdVelDisplay.innerHTML = formattedMsg;
    }

    // 添加处理激光扫描数据的函数
    function displayScanData(message) {
      if (!ctx || !canvas) return;
      
      // 清空画布
      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // 设置点的样式
      ctx.fillStyle = 'lime';
      
      // 计算中心点
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      
      // 获取扫描参数
      const angleMin = message.angle_min;
      const angleIncrement = message.angle_increment;
      const rangeMax = message.range_max;
      
      // 缩放因子 - 使点云尺寸适应画布
      const scaleFactor = Math.min(canvas.width, canvas.height) / (2 * rangeMax) * 0.8;
      
      // 绘制机器人位置
      ctx.fillStyle = 'red';
      ctx.beginPath();
      ctx.arc(centerX, centerY, 4, 0, Math.PI * 2);
      ctx.fill();
      
      // 绘制点云
      ctx.fillStyle = 'lime';
      for (let i = 0; i < message.ranges.length; i++) {
        const range = message.ranges[i];
        
        // 跳过无效的读数
        if (range < message.range_min || range > message.range_max) continue;
        
        // 计算当前角度
        const angle = angleMin + (i * angleIncrement);
        
        // 将极坐标转换为笛卡尔坐标
        // 注意: 激光扫描通常以前方为0度，右侧为负角度，左侧为正角度
        // 而canvas坐标系是以向右为x轴正方向，向下为y轴正方向
        const x = centerX + Math.cos(angle) * range * scaleFactor;
        const y = centerY - Math.sin(angle) * range * scaleFactor; // 注意y轴方向取反
        
        // 绘制点
        ctx.beginPath();
        ctx.arc(x, y, 2, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // 绘制坐标轴
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.beginPath();
      ctx.moveTo(centerX, 0);
      ctx.lineTo(centerX, canvas.height);
      ctx.moveTo(0, centerY);
      ctx.lineTo(canvas.width, centerY);
      ctx.stroke();
    }

    function move(direction) {
      if (!ros) {
        console.error('ROS connection not established');
        alert('请先连接到ROS');
        return;
      }

      if (!cmdVel) {
        console.error('Publisher not created');
        alert('Publisher not created');
        return;
      }

      const twist = new ROSLIB.Message({
        linear: {
          x: direction.linear.x,
          y: direction.linear.y,
          z: direction.linear.z
        },
        angular: {
          x: direction.angular.x,
          y: direction.angular.y,
          z: direction.angular.z
        }
      });

      cmdVel.publish(twist);
      // 直接更新显示，无需等待订阅回调
      updateCmdVelDisplay(twist);
    }

    function moveForward() {
      const moveForwardMsg = {
        linear: { x: 0.2, y: 0, z: 0 },
        angular: { x: 0, y: 0, z: 0 }
      };
      move(moveForwardMsg);
    }

    function moveBackward() {
      const moveBackwardMsg = {
        linear: { x: -0.2, y: 0, z: 0 },
        angular: { x: 0, y: 0, z: 0 }
      };
      move(moveBackwardMsg);
    }

    function moveLeft() {
      const moveLeftMsg = {
        linear: { x: 0, y: 0.0, z: 0 },
        angular: { x: 0, y: 0, z: 0.5 }
      };
      move(moveLeftMsg);
    }

    function moveRight() {
      const moveRightMsg = {
        linear: { x: 0, y: 0, z: 0 },
        angular: { x: 0, y: 0, z: -0.5 }
      };
      move(moveRightMsg);
    }

    function stopMovement() {
      const stopMsg = {
        linear: { x: 0, y: 0, z: 0 },
        angular: { x: 0, y: 0, z: 0 }
      };
      move(stopMsg);
    }

    // 页面加载完成后自动连接
    window.onload = function() {
      // 延迟一点时间再连接，确保DOM元素已加载
      setTimeout(connect, 500);
    }
  </script>
</body>

</html>