<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;  /* 防止出现滚动条 */
  }

  .container {
    display: flex;
    width: 100vw;     /* 占满整个视口宽度 */
    height: 100vh;    /* 占满整个视口高度 */
    gap: 0;          /* 移除间距 */
    align-items: stretch;  /* 子元素拉伸以填充容器高度 */
  }

  #map {
    flex: 1;        /* 弹性布局占比为1 */
    height: 100%;   /* 填满容器高度 */
    background-color: #f0f0f0;
  }

  #control-zone {
    flex: 1;        /* 弹性布局占比为1 */
    position: relative;
    background: silver;
    height: 100%;   /* 填满容器高度 */
    display: flex;
    flex-direction: column; /* 垂直方向排列 */
  }

  #joystick {
    position: absolute;
    width: 150px;   /* 摇杆容器宽度 */
    height: 150px;  /* 摇杆容器高度 */
    border-radius: 50%;  /* 圆形 */
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);  /* 居中定位 */
  }

  .connection-info {
    position: relative;
    padding: 20px;
    text-align: center;
    flex-shrink: 0;       /* 防止内容压缩 */
  }

  .status {
    margin: 10px;
    padding: 10px;
    border-radius: 5px;
    font-weight: bold;
  }

  .status.connected {
    background-color: #27ae60;
    color: white;
  }

  .status.disconnected {
    background-color: #e74c3c;
    color: white;
  }

  button {
    margin: 5px;
    padding: 5px 15px;
    font-size: 16px;
    border: 2px solid #3498db;
    border-radius: 5px;
    background-color: #3498db;
    color: #ffffff;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  button:hover {
    background-color: #2980b9;
  }

  input[type="text"] {
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
    width: 80px;
  }

  .joystick-container {
    position: relative;
    flex: 1;              /* 占用剩余空间 */
    display: flex;
    justify-content: center;
    align-items: center;
  }
</style>

<script type="text/javascript" src="./jslib/three.js"></script>
<script type="text/javascript" src="./jslib/eventemitter2.js"></script>
<script type="text/javascript" src="./jslib/roslib.js"></script>
<script type="text/javascript" src="./jslib/ros3d.js"></script>
<script type="text/javascript" src="./jslib/nipplejs.js"></script>

<script type="text/javascript">

var ros,
    viewer,
    gridClient,
    laserScan;

function init() {
    // 获取当前页面的主机名/IP地址
    const currentHost = window.location.hostname || 'localhost';
    const port = document.getElementById('port').value;
    const rosbridgeUrl = `ws://${currentHost}:${port}`;
    
    // Connect to ROS
    ros = new ROSLIB.Ros({
        url: rosbridgeUrl
    });

    const statusElement = document.getElementById('status');

    ros.on('connection', () => {
        console.log('Connected to ROS Bridge');
        statusElement.innerHTML = `已连接到 ${rosbridgeUrl}`;
        statusElement.className = 'status connected';
        
        // 创建viewer等其他对象
        initializeViewer();
    });

    ros.on('error', (error) => {
        console.error('Error connecting to ROS: ', error);
        statusElement.innerHTML = `连接失败: ${error}`;
        statusElement.className = 'status disconnected';
    });

    ros.on('close', () => {
        console.log('Disconnected from ROS');
        statusElement.innerHTML = '已断开连接';
        statusElement.className = 'status disconnected';
        cleanupViewer();  // 断开时清理实例
    });
}

function initializeViewer() {
    // 清理旧的订阅和场景对象
    cleanupViewer();

    // 如果viewer不存在才创建新的实例
    if (!viewer) {
        viewer = new ROS3D.Viewer({
            divID : 'map',
            width : document.documentElement.clientWidth / 2,
            height : document.documentElement.clientHeight,
            antialias : false
        });

        //初始化相机位置
        viewer.cameraControls.camera.position.set(-0.0000001, 0, 10);
    }

    // Setup the map client.
    gridClient = new ROS3D.OccupancyGridClient({
      ros : ros,
      rootObject : viewer.scene,
      continuous : true,
    });

    laserScan = new ROS3D.LaserScan({
      ros : ros,
      rootObject : viewer.scene,
      topic : '/scan',
      tfClient : new ROSLIB.TFClient({
        ros : ros,
        fixedFrame : 'map',
        angularThres : 0.01,
        transThres : 0.01,
        rate : 10.0
      }),
      material: {
        size: 0.05,
        color: 0xff00ff
      }
    });
}

function connect() {
    if (ros) {
        ros.close();
        cleanupViewer();  // 清理旧的实例
    }
    init();
}

// 清理viewer和订阅的对象
function cleanupViewer() {
    if (laserScan) {
        laserScan.unsubscribe();
        if (viewer && viewer.scene) {
            viewer.scene.remove(laserScan);
        }
        laserScan = null;
    }
    
    if (gridClient) {
        gridClient.unsubscribe();
        if (viewer && viewer.scene) {
            viewer.scene.remove(gridClient);
        }
        gridClient = null;
    }

    if (viewer && viewer.scene) {
        // 只清理场景中的对象，保留viewer实例
        while(viewer.scene.children.length > 0){ 
            viewer.scene.remove(viewer.scene.children[0]); 
        }
    }
}

  function bottom1() {
    viewer.cameraControls.camera.position.x = -0.0000001;
    viewer.cameraControls.camera.position.y = 0;
    viewer.cameraControls.camera.position.z = 1;
  }

  function bottom2() {
    viewer.cameraControls.center.x = 0;
    viewer.cameraControls.center.y = 0.74;
    viewer.cameraControls.center.z = 0;
  }

  function bottom3() {
    viewer.start();
  }

  window.addEventListener('resize', function() {
    viewer.resize(
      document.documentElement.clientWidth / 2,
      document.documentElement.clientHeight
    );
  });
</script>
</head>

<body onload="init()">
  <div class="container">
    <div id="map"></div>
    <div id="control-zone">
        <div class="connection-info">
            <div id="status" class="status disconnected">未连接</div>
            <div>
                <label for="port">Rosbridge端口：</label>
                <input type="text" id="port" value="9090" />
                <button onclick="connect()">连接</button>
            </div>
        </div>
        <div class="joystick-container">
            <div id="joystick"></div>
        </div>
    </div>
  </div>

  <script>
    var options = {
        zone: document.getElementById('joystick'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: 'red',
        size: 150,
    };

    var joystick = nipplejs.create(options);
    
    // 摇杆状态
    var joystickState = {
        active: false,
        distance: 0,
        angle: 0
    };

    // 更新相机位置
    function updateCamera() {
        if (joystickState.active) {
            // 相机与中心点距离为1时，摇杆单位距离对应的相机移动距离参数
            var cameraDistancePerJoystickUnit = 0.00015;

            // 计算相机朝向二维向量
            var cameraDirection = new THREE.Vector2();
            cameraDirection.subVectors(viewer.cameraControls.center, viewer.cameraControls.camera.position);
            // 计算相机朝向的角度
            var cameraAngle = Math.atan2(cameraDirection.y, cameraDirection.x);
            // 计算相机和中心点的距离
            var cameraDistance = viewer.cameraControls.camera.position.distanceTo(viewer.cameraControls.center);

            // 计算相机和中心点移动的增量
            var cameraDeltaX = joystickState.distance * Math.sin(joystickState.angle + cameraAngle) * cameraDistancePerJoystickUnit * cameraDistance;
            var cameraDeltaY = joystickState.distance * -Math.cos(joystickState.angle + cameraAngle) * cameraDistancePerJoystickUnit * cameraDistance;
            var centerDeltaX = joystickState.distance * Math.sin(joystickState.angle + cameraAngle) * cameraDistancePerJoystickUnit * cameraDistance;
            var centerDeltaY = joystickState.distance * -Math.cos(joystickState.angle + cameraAngle) * cameraDistancePerJoystickUnit * cameraDistance;

            viewer.cameraControls.camera.position.add(new THREE.Vector3(cameraDeltaX, cameraDeltaY, 0));
            viewer.cameraControls.center.add(new THREE.Vector3(centerDeltaX, centerDeltaY, 0));
        }
        requestAnimationFrame(updateCamera);
    }

    // 启动动画循环
    updateCamera();

    // 摇杆移动事件
    joystick.on('move', function (evt, data) {
        joystickState.active = true;
        joystickState.distance = data.distance;
        joystickState.angle = data.angle.radian;
    });

    // 摇杆释放事件
    joystick.on('end', function () {
        joystickState.active = false;
        joystickState.distance = 0;
        joystickState.angle = 0;
    });
  </script>
</body>
</html>
